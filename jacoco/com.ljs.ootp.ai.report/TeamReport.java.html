<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>TeamReport.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ootp-ai</a> &gt; <a href="index.source.html" class="el_package">com.ljs.ootp.ai.report</a> &gt; <span class="el_source">TeamReport.java</span></div><h1>TeamReport.java</h1><pre class="source lang-java linenums">package com.ljs.ootp.ai.report;

import com.ljs.ootp.ai.data.Id;
import com.ljs.ootp.ai.io.Printable;
import com.ljs.ootp.ai.player.Player;
import com.ljs.ootp.ai.player.Slot;
import com.ljs.ootp.ai.regression.Predictions;
import com.ljs.ootp.ai.roster.Team;
import com.ljs.ootp.ai.selection.HitterSelectionFactory;
import com.ljs.ootp.ai.selection.Mode;
import com.ljs.ootp.ai.selection.PitcherSelectionFactory;
import com.ljs.ootp.ai.selection.Selection;
import com.ljs.ootp.ai.selection.SelectionFactory;
import com.ljs.ootp.ai.selection.Selections;
import com.ljs.ootp.ai.selection.SlotSelection;
import com.ljs.ootp.ai.site.LeagueStructure;
import com.ljs.ootp.ai.site.Record;
import com.ljs.ootp.ai.site.RecordPredictor;
import com.ljs.ootp.ai.site.Site;
import com.ljs.ootp.ai.site.Standings;
import com.ljs.ootp.ai.stats.PitchingStats;

import java.io.PrintWriter;

import java.util.Set;

import com.google.common.base.Function;
import com.google.common.base.Strings;
import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableMultiset;
import com.google.common.collect.ImmutableSet;
import com.google.common.collect.Ordering;
import com.google.common.collect.Sets;

import org.apache.commons.lang3.StringUtils;
import org.apache.commons.math3.stat.descriptive.DescriptiveStatistics;

/**
 *
 * @author lstephen
 */
public final class TeamReport implements Printable, RecordPredictor {

    private final String title;

    private final Site site;

    private final Function&lt;Player, Integer&gt; value;

    private final PitchingStats leaguePitching;

<span class="fc" id="L52">    private final DescriptiveStatistics mlHitting = new DescriptiveStatistics();</span>

<span class="fc" id="L54">    private final DescriptiveStatistics mlPitching = new DescriptiveStatistics();</span>

    private Set&lt;TeamScore&gt; scores;

    private Ordering&lt;TeamScore&gt; ordering;

    private Predictions ps;

<span class="fc" id="L62">    private TeamReport(String title, Site site, Predictions ps, Function&lt;Player, Integer&gt; value) {</span>
<span class="fc" id="L63">        this.title = title;</span>
<span class="fc" id="L64">        this.site = site;</span>
<span class="fc" id="L65">        this.ps = ps;</span>
<span class="fc" id="L66">        this.value = value;</span>
<span class="fc" id="L67">        this.leaguePitching = site.getLeaguePitching();</span>
<span class="fc" id="L68">    }</span>

    public void sortByTalentLevel() {
<span class="nc" id="L71">        ordering = TeamScore.byWinningPercentage(getExpectedRunsPerGame());</span>
<span class="nc" id="L72">    }</span>

    public void sortByEndOfSeason() {
<span class="nc" id="L75">        ordering = Ordering</span>
<span class="nc" id="L76">            .natural()</span>
<span class="nc" id="L77">            .reverse()</span>
<span class="nc" id="L78">            .onResultOf(score -&gt; getExpectedEndOfSeason(score.getId()).getWinPercentage());</span>
<span class="nc" id="L79">    }</span>

    private Ordering&lt;TeamScore&gt; getOrdering() {
<span class="nc bnc" id="L82" title="All 2 branches missed.">        return ordering == null</span>
<span class="nc" id="L83">            ? TeamScore.byWinningPercentage(getExpectedRunsPerGame())</span>
            : ordering;
    }

    private Set&lt;TeamScore&gt; getScores() {
<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (scores == null) {</span>
<span class="nc" id="L89">            scores = calculateScores();</span>
        }

<span class="nc" id="L92">        return scores;</span>
    }

    private TeamScore getScore(Id&lt;Team&gt; team) {
<span class="nc bnc" id="L96" title="All 2 branches missed.">        for (TeamScore s : getScores()) {</span>
<span class="nc bnc" id="L97" title="All 2 branches missed.">            if (s.getId().equals(team)) {</span>
<span class="nc" id="L98">                return s;</span>
            }
<span class="nc" id="L100">        }</span>
<span class="nc" id="L101">        throw new IllegalStateException();</span>
    }

    private Set&lt;TeamScore&gt; calculateScores() {
<span class="nc" id="L105">        Set&lt;TeamScore&gt; scores = Sets.newHashSet();</span>

<span class="nc bnc" id="L107" title="All 2 branches missed.">        for (Id&lt;Team&gt; id : site.getTeamIds()) {</span>
<span class="nc" id="L108">            scores.add(calculate(id));</span>
<span class="nc" id="L109">        }</span>

<span class="nc" id="L111">        return normalize(scores);</span>
    }

    private Double getExpectedRunsPerGame() {
<span class="fc" id="L115">        return site.getPitcherSelectionMethod().getEraEstimate(leaguePitching);</span>
    }

    @Override
    public void print(PrintWriter w) {
<span class="fc" id="L120">        w.println();</span>
<span class="fc" id="L121">        w.println(String.format(&quot;**%-18s | %-5s %-5s %-5s | %-5s %-5s %-5s | (rpg:%.2f)&quot;, title, &quot; Bat&quot;, &quot; LU&quot;, &quot; Ovr&quot;, &quot; Pit&quot;, &quot; Rot&quot;, &quot; Ovr&quot;, getExpectedRunsPerGame()));</span>

<span class="pc bpc" id="L123" title="1 of 2 branches missed.">        for (LeagueStructure.League league : site.getLeagueStructure().getLeagues()) {</span>
<span class="nc" id="L124">            w.println();</span>
<span class="nc" id="L125">            w.println(league.getName());</span>

<span class="nc bnc" id="L127" title="All 2 branches missed.">            for (LeagueStructure.Division division : league.getDivisions()) {</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">                if (!Strings.isNullOrEmpty(division.getName())) {</span>
<span class="nc" id="L129">                    w.println(StringUtils.rightPad(division.getName() + &quot; &quot;, 21, '-') + &quot;+&quot;);</span>
                }

<span class="nc" id="L132">                Set&lt;TeamScore&gt; divisionScores = Sets.newHashSet();</span>

<span class="nc bnc" id="L134" title="All 2 branches missed.">                for (Id&lt;Team&gt; team : division.getTeams()) {</span>
<span class="nc" id="L135">                    divisionScores.add(getScore(team));</span>
<span class="nc" id="L136">                }</span>

<span class="nc bnc" id="L138" title="All 2 branches missed.">                for (TeamScore s : getOrdering().sortedCopy(divisionScores)) {</span>
<span class="nc" id="L139">                    printTeamScore(s, w);</span>
<span class="nc" id="L140">                }</span>
<span class="nc" id="L141">            }</span>
<span class="nc" id="L142">        }</span>

<span class="fc" id="L144">        w.println(String.format(&quot;%-20s | %11s %5.1f | %11s %5.1f |&quot;, &quot;&quot;, &quot;&quot;, mlHitting.getMean(), &quot;&quot;, mlPitching.getMean()));</span>

<span class="fc" id="L146">        w.flush();</span>
<span class="fc" id="L147">    }</span>

    private Integer getOverallPosition(TeamScore score) {
<span class="nc" id="L150">        ImmutableList&lt;TeamScore&gt; scores = getOrdering().immutableSortedCopy(getScores());</span>

<span class="nc" id="L152">        return scores.indexOf(score) + 1;</span>
    }

    private void printTeamScore(TeamScore s, PrintWriter w) {
<span class="nc" id="L156">        Record current = site.getStandings().getRecord(s.getId());</span>
<span class="nc" id="L157">        Record eos = getExpectedEndOfSeason(s.getId());</span>

<span class="nc" id="L159">        w.println(</span>
<span class="nc" id="L160">            String.format(</span>
                &quot;%-20s | %5.1f %5.1f %5.1f | %5.1f %5.1f %5.1f | %s %.3f | %3d-%3d %.3f | %3d-%3d %.3f (%2d) &quot;,
<span class="nc" id="L162">                StringUtils.abbreviate(site.getSingleTeam(s.getId()).getName(), 20),</span>
<span class="nc" id="L163">                s.getBatting(),</span>
<span class="nc" id="L164">                s.getLineup(),</span>
<span class="nc" id="L165">                s.getOverallBatting(),</span>
<span class="nc" id="L166">                s.getPitching(),</span>
<span class="nc" id="L167">                s.getRotation(),</span>
<span class="nc" id="L168">                s.getOverallPitching(),</span>
<span class="nc" id="L169">                s.getExpectedReocrd(getExpectedRunsPerGame()),</span>
<span class="nc" id="L170">                s.getExpectedWinningPercentage(getExpectedRunsPerGame()),</span>
<span class="nc" id="L171">                current.getWins(),</span>
<span class="nc" id="L172">                current.getLosses(),</span>
<span class="nc" id="L173">                current.getWinPercentage(),</span>
<span class="nc" id="L174">                eos.getWins(),</span>
<span class="nc" id="L175">                eos.getLosses(),</span>
<span class="nc" id="L176">                eos.getWinPercentage(),</span>
<span class="nc" id="L177">                getOverallPosition(s)</span>
                ));

<span class="nc" id="L180">    }</span>

    public Record getExpectedEndOfSeason(Id&lt;Team&gt; team) {
<span class="nc" id="L183">        Standings standings = site.getStandings();</span>

<span class="nc" id="L185">        Record current = standings.getRecord(team);</span>

<span class="nc" id="L187">        Long eosWs = current.getWins()</span>
<span class="nc" id="L188">            + Math.round(</span>
<span class="nc" id="L189">                getScore(team)</span>
<span class="nc" id="L190">                    .getExpectedWinningPercentage(getExpectedRunsPerGame())</span>
<span class="nc" id="L191">                    * (162 - current.getGames()));</span>

<span class="nc" id="L193">        Long eosLs = 162 - eosWs;</span>

<span class="nc" id="L195">        return Record.create(eosWs, eosLs);</span>
    }

    private Set&lt;TeamScore&gt; normalize(Iterable&lt;TeamScore&gt; scores) {
<span class="nc" id="L199">        Double battingAverage = getBattingAverage(scores);</span>
<span class="nc" id="L200">        Double lineupAverage = getLineupAverage(scores);</span>
<span class="nc" id="L201">        Double pitchingAverage = getPitchingAverage(scores);</span>
<span class="nc" id="L202">        Double rotationAverage = getRotationAverage(scores);</span>

<span class="nc" id="L204">        Set&lt;TeamScore&gt; normalized = Sets.newHashSet();</span>

<span class="nc bnc" id="L206" title="All 2 branches missed.">        for (TeamScore s : scores) {</span>
<span class="nc" id="L207">            normalized.add(</span>
<span class="nc" id="L208">                TeamScore.create(</span>
<span class="nc" id="L209">                    s.getId(),</span>
<span class="nc" id="L210">                    normalize(s.getBatting(), battingAverage),</span>
<span class="nc" id="L211">                    normalize(s.getLineup(), lineupAverage),</span>
<span class="nc" id="L212">                    normalize(s.getPitching(), pitchingAverage),</span>
<span class="nc" id="L213">                    normalize(s.getRotation(), rotationAverage)));</span>
<span class="nc" id="L214">        }</span>

<span class="nc" id="L216">        return normalized;</span>
    }

    private Double normalize(Double value, Double average) {
<span class="nc" id="L220">        return value * 100 / average;</span>
    }

    private Double getBattingAverage(Iterable&lt;TeamScore&gt; scores) {
<span class="nc" id="L224">        DescriptiveStatistics stats = new DescriptiveStatistics();</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">        for (TeamScore s : scores) {</span>
<span class="nc" id="L226">            stats.addValue(s.getBatting());</span>
<span class="nc" id="L227">        }</span>

<span class="nc" id="L229">        return stats.getMean();</span>

    }

    private Double getLineupAverage(Iterable&lt;TeamScore&gt; scores) {
<span class="nc" id="L234">        DescriptiveStatistics stats = new DescriptiveStatistics();</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">        for (TeamScore s : scores) {</span>
<span class="nc" id="L236">            stats.addValue(s.getLineup());</span>
<span class="nc" id="L237">        }</span>
<span class="nc" id="L238">        return stats.getMean();</span>
    }

    private Double getPitchingAverage(Iterable&lt;TeamScore&gt; scores) {
<span class="nc" id="L242">        DescriptiveStatistics stats = new DescriptiveStatistics();</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">        for (TeamScore s : scores) {</span>
<span class="nc" id="L244">            stats.addValue(s.getPitching());</span>
<span class="nc" id="L245">        }</span>
<span class="nc" id="L246">        return stats.getMean();</span>
    }

    private Double getRotationAverage(Iterable&lt;TeamScore&gt; scores) {
<span class="nc" id="L250">        DescriptiveStatistics stats = new DescriptiveStatistics();</span>
<span class="nc bnc" id="L251" title="All 2 branches missed.">        for (TeamScore s : scores) {</span>
<span class="nc" id="L252">            stats.addValue(s.getRotation());</span>
<span class="nc" id="L253">        }</span>
<span class="nc" id="L254">        return stats.getMean();</span>
    }

    private TeamScore calculate(Id&lt;Team&gt; id) {
<span class="nc" id="L258">        return calculate(id, site.getSingleTeam(id).getRoster().getAllPlayers());</span>
    }

    private TeamScore calculate(Id&lt;Team&gt; id, Iterable&lt;Player&gt; players) {
<span class="nc" id="L262">        return TeamScore.create(</span>
            id,
<span class="nc" id="L264">            calculateBatting(players),</span>
<span class="nc" id="L265">            calculateLineup(players),</span>
<span class="nc" id="L266">            calculatePitching(players),</span>
<span class="nc" id="L267">            calculateRotation(players));</span>
    }

    private Double calculateBatting(Iterable&lt;Player&gt; players) {
<span class="nc" id="L271">        return calculateScore(</span>
<span class="nc" id="L272">            HitterSelectionFactory.using(ps.getAllBatting(), value).slot(Mode.REGULAR_SEASON),</span>
<span class="nc" id="L273">            Selections.onlyHitters(players));</span>
    }

    private Double calculateLineup(Iterable&lt;Player&gt; players) {
<span class="nc" id="L277">        return calculateScore(</span>
            SlotSelection
<span class="nc" id="L279">                .builder()</span>
<span class="nc" id="L280">                .ordering(Ordering.natural().reverse().onResultOf(value))</span>
<span class="nc" id="L281">                .slots(ImmutableMultiset.of(Slot.C, Slot.SS, Slot.IF, Slot.IF, Slot.CF, Slot.OF, Slot.OF, Slot.H, Slot.H))</span>
<span class="nc" id="L282">                .size(9)</span>
<span class="nc" id="L283">                .fillToSize(Slot.H)</span>
<span class="nc" id="L284">                .build(),</span>
<span class="nc" id="L285">            Selections.onlyHitters(players));</span>
    }

    private Double calculatePitching(Iterable&lt;Player&gt; players) {
<span class="nc" id="L289">        return calculateScore(</span>
<span class="nc" id="L290">            PitcherSelectionFactory.using(value).slot(Mode.REGULAR_SEASON),</span>
<span class="nc" id="L291">            Selections.onlyPitchers(players));</span>
    }

    private Double calculateRotation(Iterable&lt;Player&gt; players) {
<span class="nc" id="L295">        return calculateScore(</span>
            SlotSelection
<span class="nc" id="L297">                .builder()</span>
<span class="nc" id="L298">                .ordering(Ordering.natural().reverse().onResultOf(value))</span>
<span class="nc" id="L299">                .slots(ImmutableMultiset.of(Slot.SP, Slot.SP, Slot.SP, Slot.SP, Slot.MR, Slot.MR, Slot.MR))</span>
<span class="nc" id="L300">                .size(7)</span>
<span class="nc" id="L301">                .fillToSize(Slot.P)</span>
<span class="nc" id="L302">                .build(),</span>
<span class="nc" id="L303">            Selections.onlyPitchers(players));</span>
    }

    private Double calculateScore(Selection selection, Iterable&lt;Player&gt; players) {
<span class="nc" id="L307">        Iterable&lt;Player&gt; ml = selection</span>
<span class="nc" id="L308">            .select(ImmutableSet.&lt;Player&gt;of(), players)</span>
<span class="nc" id="L309">            .values();</span>

<span class="nc" id="L311">        DescriptiveStatistics stats = new DescriptiveStatistics();</span>

<span class="nc bnc" id="L313" title="All 2 branches missed.">        for (Player p : ml) {</span>
<span class="nc" id="L314">            stats.addValue(value.apply(p));</span>
<span class="nc" id="L315">            addToAverages(p);</span>
<span class="nc" id="L316">        }</span>

<span class="nc" id="L318">        return stats.getMean();</span>
    }

    private void addToAverages(Player p) {
<span class="nc bnc" id="L322" title="All 2 branches missed.">        if (Selections.isHitter(p)) {</span>
<span class="nc" id="L323">            mlHitting.addValue(value.apply(p));</span>
        }

<span class="nc bnc" id="L326" title="All 2 branches missed.">        if (Selections.isPitcher(p)) {</span>
<span class="nc" id="L327">            mlPitching.addValue(value.apply(p));</span>
        }
<span class="nc" id="L329">    }</span>

    public static TeamReport create(String title, Predictions ps, Site site, Function&lt;Player, Integer&gt; value) {
<span class="fc" id="L332">        return new TeamReport(title, site, ps, value);</span>
    }

    private static final class TeamScore {

        private final Id&lt;Team&gt; id;

        private final Double batting;

        private final Double lineup;

        private final Double pitching;

        private final Double rotation;

<span class="nc" id="L347">        private TeamScore(Id&lt;Team&gt; id, Double batting, Double lineup, Double pitching, Double rotation) {</span>
<span class="nc" id="L348">            this.id = id;</span>
<span class="nc" id="L349">            this.batting = batting;</span>
<span class="nc" id="L350">            this.lineup = lineup;</span>
<span class="nc" id="L351">            this.pitching = pitching;</span>
<span class="nc" id="L352">            this.rotation = rotation;</span>
<span class="nc" id="L353">        }</span>

        public Id&lt;Team&gt; getId() {
<span class="nc" id="L356">            return id;</span>
        }

        public Double getBatting() {
<span class="nc" id="L360">            return batting;</span>
        }

        public Double getLineup() {
<span class="nc" id="L364">            return lineup;</span>
        }

        public Double getPitching() {
<span class="nc" id="L368">            return pitching;</span>
        }

        public Double getRotation() {
<span class="nc" id="L372">            return rotation;</span>
        }

        public Double getOverallBatting() {
<span class="nc" id="L376">            return combine(batting, lineup);</span>
        }

        public Double getOverallPitching() {
<span class="nc" id="L380">            return combine(pitching, rotation);</span>
        }

        private Double combine(Double depth, Double strength) {
<span class="nc" id="L384">            double a = .5 * depth / 100;</span>
<span class="nc" id="L385">            double b = .5 * 100 / strength;</span>

<span class="nc" id="L387">            double log5 = (a - a*b) / (a + b - 2*a*b);</span>

<span class="nc" id="L389">            return 100 * log5 / .5;</span>
        }

        /**
         * Assumption - normalized to an average of 100
         * @return
         */
        public Double getExpectedWinningPercentage(double rpg) {
<span class="nc" id="L397">            int averageRuns = (int) (rpg * 162);</span>

<span class="nc" id="L399">            double rs = getOverallBatting() * averageRuns / 100;</span>
<span class="nc" id="L400">            double ra = (100.0 / getOverallPitching() * 100) * averageRuns / 100;</span>

<span class="nc" id="L402">            return 1.0 / (1.0 + Math.pow(ra / rs, 2));</span>
        }

        public String getExpectedReocrd(double rpg) {
<span class="nc" id="L406">            Long wins = Math.round(162 * getExpectedWinningPercentage(rpg));</span>

<span class="nc" id="L408">            return String.format(&quot;%3d-%3d&quot;, wins, 162-wins);</span>
        }

        public static TeamScore create(
            Id&lt;Team&gt; id, Double batting, Double lineup, Double pitching, Double rotation) {

<span class="nc" id="L414">            return new TeamScore(id, batting, lineup, pitching, rotation);</span>
        }

        public static Ordering&lt;TeamScore&gt; byWinningPercentage(final double rpg) {
            return Ordering
<span class="nc" id="L419">                .natural()</span>
<span class="nc" id="L420">                .reverse()</span>
<span class="nc" id="L421">                .onResultOf(s -&gt; s.getExpectedWinningPercentage(rpg));</span>
        }

    }

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>