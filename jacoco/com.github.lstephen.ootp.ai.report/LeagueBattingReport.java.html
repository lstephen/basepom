<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>LeagueBattingReport.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ootp-ai</a> &gt; <a href="index.source.html" class="el_package">com.github.lstephen.ootp.ai.report</a> &gt; <span class="el_source">LeagueBattingReport.java</span></div><h1>LeagueBattingReport.java</h1><pre class="source lang-java linenums">package com.github.lstephen.ootp.ai.report;

import com.google.common.collect.ImmutableMap;
import com.github.lstephen.ootp.ai.io.Printable;
import com.github.lstephen.ootp.ai.site.Site;
import com.github.lstephen.ootp.ai.stats.BattingStats;
import com.github.lstephen.ootp.ai.stats.BaseRuns;
import com.github.lstephen.ootp.ai.stats.EraBaseRuns;
import com.github.lstephen.ootp.ai.stats.FipBaseRuns;
import com.github.lstephen.ootp.ai.stats.Woba;
import java.io.PrintWriter;

/**
 *
 * @author lstephen
 */
public class LeagueBattingReport implements Printable {

  private final BattingStats stats;

  private final Double bsrFactor;

<span class="fc" id="L23">  private LeagueBattingReport(BattingStats stats) {</span>
<span class="fc" id="L24">    this.stats = stats;</span>

<span class="fc" id="L26">    Double a = (double) stats.getHits() + stats.getWalks() - stats.getHomeRuns();</span>

<span class="fc" id="L28">    Double b =</span>
<span class="fc" id="L29">      BaseRuns.COEFFICIENT_SINGLE * stats.getSingles() +</span>
<span class="fc" id="L30">      BaseRuns.COEFFICIENT_DOUBLE * stats.getDoubles() +</span>
<span class="fc" id="L31">      BaseRuns.COEFFICIENT_TRIPLE * stats.getTriples() +</span>
<span class="fc" id="L32">      BaseRuns.COEFFICIENT_HOME_RUN * stats.getHomeRuns() +</span>
<span class="fc" id="L33">      BaseRuns.COEFFICIENT_WALK * stats.getWalks() +</span>
<span class="fc" id="L34">      BaseRuns.COEFFICIENT_STRIKEOUT * stats.getStrikeouts() +</span>
<span class="fc" id="L35">      BaseRuns.COEFFICIENT_OUT * (stats.getOuts() - stats.getStrikeouts());</span>

<span class="fc" id="L37">    Double c = (double) stats.getOuts();</span>

<span class="fc" id="L39">    Double d = (double) stats.getHomeRuns();</span>

<span class="fc" id="L41">    Double z = (stats.getRuns() - d) / a;</span>
<span class="fc" id="L42">    bsrFactor = (z * c/(1 - z)) / b;</span>
<span class="fc" id="L43">  }</span>

  @Override
  public void print(PrintWriter w) {

<span class="fc" id="L48">    w.format(&quot;bsf: %.2f%n&quot;, bsrFactor);</span>
<span class="fc" id="L49">    w.format(&quot;act: %d%n&quot;, stats.getRuns());</span>
<span class="fc" id="L50">    w.println();</span>

<span class="fc" id="L52">    Double runBB = getRunValueBB();</span>
<span class="fc" id="L53">    Double run1B = getRunValue1B();</span>
<span class="fc" id="L54">    Double run2B = getRunValue2B();</span>
<span class="fc" id="L55">    Double run3B = getRunValue3B();</span>
<span class="fc" id="L56">    Double runHR = getRunValueHR();</span>

<span class="fc" id="L58">    w.println();</span>
<span class="fc" id="L59">    w.format(&quot;runBB: %.2f%n&quot;, runBB);</span>
<span class="fc" id="L60">    w.format(&quot;run1B: %.2f%n&quot;, run1B);</span>
<span class="fc" id="L61">    w.format(&quot;run2B: %.2f%n&quot;, run2B);</span>
<span class="fc" id="L62">    w.format(&quot;run3B: %.2f%n&quot;, run3B);</span>
<span class="fc" id="L63">    w.format(&quot;runHR: %.2f%n&quot;, runHR);</span>

<span class="fc" id="L65">    Double runsMinus = (runBB * stats.getWalks()</span>
<span class="fc" id="L66">        + run1B * stats.getSingles()</span>
<span class="fc" id="L67">        + run2B * stats.getDoubles()</span>
<span class="fc" id="L68">        + run3B * stats.getTriples()</span>
<span class="fc" id="L69">        + runHR * stats.getHomeRuns())</span>
<span class="fc" id="L70">      / stats.getOuts();</span>

<span class="fc" id="L72">    Double runsPlus = (runBB * stats.getWalks()</span>
<span class="fc" id="L73">        + run1B * stats.getSingles()</span>
<span class="fc" id="L74">        + run2B * stats.getDoubles()</span>
<span class="fc" id="L75">        + run3B * stats.getTriples()</span>
<span class="fc" id="L76">        + runHR * stats.getHomeRuns())</span>
<span class="fc" id="L77">      / (stats.getWalks() + stats.getHits());</span>

<span class="fc" id="L79">    Double wobaScale = 1 / (runsPlus + runsMinus);</span>

<span class="fc" id="L81">    Double bipValue = stats.getBabip() * runsPlus - (1.0 - stats.getBabip()) * runsMinus;</span>

<span class="fc" id="L83">    w.format(&quot;rnBIP: %.2f%n&quot;, bipValue);</span>

<span class="fc" id="L85">    w.println();</span>
<span class="fc" id="L86">    w.format(&quot;runs-: %.2f%n&quot;, runsMinus);</span>
<span class="fc" id="L87">    w.format(&quot;runs+: %.2f%n&quot;, runsPlus);</span>
<span class="fc" id="L88">    w.format(&quot;wobas: %.2f%n&quot;, wobaScale);</span>


<span class="fc" id="L91">    Double wobaBB = (runBB + runsMinus) * wobaScale;</span>
<span class="fc" id="L92">    Double woba1B = (run1B + runsMinus) * wobaScale;</span>
<span class="fc" id="L93">    Double woba2B = (run2B + runsMinus) * wobaScale;</span>
<span class="fc" id="L94">    Double woba3B = (run3B + runsMinus) * wobaScale;</span>
<span class="fc" id="L95">    Double wobaHR = (runHR + runsMinus) * wobaScale;</span>

<span class="fc" id="L97">    w.println();</span>
<span class="fc" id="L98">    w.format(&quot;wobaBB: %.2f%n&quot;, wobaBB);</span>
<span class="fc" id="L99">    w.format(&quot;woba1B: %.2f%n&quot;, woba1B);</span>
<span class="fc" id="L100">    w.format(&quot;woba2B: %.2f%n&quot;, woba2B);</span>
<span class="fc" id="L101">    w.format(&quot;woba3B: %.2f%n&quot;, woba3B);</span>
<span class="fc" id="L102">    w.format(&quot;wobaHR: %.2f%n&quot;, wobaHR);</span>

<span class="fc" id="L104">    Woba.setConstants(ImmutableMap</span>
<span class="fc" id="L105">        .&lt;Woba.Event, Double&gt;builder()</span>
<span class="fc" id="L106">        .put(Woba.Event.WALK, wobaBB)</span>
<span class="fc" id="L107">        .put(Woba.Event.SINGLE, woba1B)</span>
<span class="fc" id="L108">        .put(Woba.Event.DOUBLE, woba2B)</span>
<span class="fc" id="L109">        .put(Woba.Event.TRIPLE, woba3B)</span>
<span class="fc" id="L110">        .put(Woba.Event.HOME_RUN, wobaHR)</span>
<span class="fc" id="L111">        .build());</span>

<span class="fc" id="L113">    w.println();</span>

<span class="fc" id="L115">    FipBaseRuns.setFactor(bsrFactor);</span>
<span class="fc" id="L116">    FipBaseRuns.setLeagueContext(stats);</span>
<span class="fc" id="L117">    EraBaseRuns.setFactor(bsrFactor);</span>
<span class="fc" id="L118">    EraBaseRuns.setLeagueContext(stats);</span>
<span class="fc" id="L119">  }</span>

  private Double getRunValueBB() {
<span class="fc" id="L122">    BattingStats plusOne = new BattingStats();</span>
<span class="fc" id="L123">    plusOne.setWalks(1);</span>

<span class="fc" id="L125">    return baseRuns(stats.add(plusOne)) - stats.getRuns();</span>
  }

  private Double getRunValue1B() {
<span class="fc" id="L129">    BattingStats plusOne = new BattingStats();</span>
<span class="fc" id="L130">    plusOne.setHits(1);</span>
<span class="fc" id="L131">    plusOne.setAtBats(1);</span>

<span class="fc" id="L133">    return baseRuns(stats.add(plusOne)) - stats.getRuns();</span>
  }

  private Double getRunValue2B() {
<span class="fc" id="L137">    BattingStats plusOne = new BattingStats();</span>
<span class="fc" id="L138">    plusOne.setHits(1);</span>
<span class="fc" id="L139">    plusOne.setAtBats(1);</span>
<span class="fc" id="L140">    plusOne.setDoubles(1);</span>

<span class="fc" id="L142">    return baseRuns(stats.add(plusOne)) - stats.getRuns();</span>
  }

  private Double getRunValue3B() {
<span class="fc" id="L146">    BattingStats plusOne = new BattingStats();</span>
<span class="fc" id="L147">    plusOne.setHits(1);</span>
<span class="fc" id="L148">    plusOne.setAtBats(1);</span>
<span class="fc" id="L149">    plusOne.setTriples(1);</span>

<span class="fc" id="L151">    return baseRuns(stats.add(plusOne)) - stats.getRuns();</span>
  }

  private Double getRunValueHR() {
<span class="fc" id="L155">    BattingStats plusOne = new BattingStats();</span>
<span class="fc" id="L156">    plusOne.setHits(1);</span>
<span class="fc" id="L157">    plusOne.setAtBats(1);</span>
<span class="fc" id="L158">    plusOne.setHomeRuns(1);</span>

<span class="fc" id="L160">    return baseRuns(stats.add(plusOne)) - stats.getRuns();</span>
  }


  private Double baseRuns(BattingStats stats) {

<span class="fc" id="L166">    Double a = (double) stats.getHits() + stats.getWalks() - stats.getHomeRuns();</span>

<span class="fc" id="L168">    Double b =</span>
<span class="fc" id="L169">      BaseRuns.COEFFICIENT_SINGLE * stats.getSingles() +</span>
<span class="fc" id="L170">      BaseRuns.COEFFICIENT_DOUBLE * stats.getDoubles() +</span>
<span class="fc" id="L171">      BaseRuns.COEFFICIENT_TRIPLE * stats.getTriples() +</span>
<span class="fc" id="L172">      BaseRuns.COEFFICIENT_HOME_RUN * stats.getHomeRuns() +</span>
<span class="fc" id="L173">      BaseRuns.COEFFICIENT_WALK * stats.getWalks() +</span>
<span class="fc" id="L174">      BaseRuns.COEFFICIENT_STRIKEOUT * stats.getStrikeouts() +</span>
<span class="fc" id="L175">      BaseRuns.COEFFICIENT_OUT * (stats.getOuts() - stats.getStrikeouts());</span>

<span class="fc" id="L177">    Double c = (double) stats.getOuts();</span>

<span class="fc" id="L179">    Double d = (double) stats.getHomeRuns();</span>

<span class="fc" id="L181">    b = bsrFactor * b;</span>

<span class="fc" id="L183">    return a * b/(b+c) + d;</span>
  }

  public static LeagueBattingReport create(Site site) {
<span class="fc" id="L187">    return new LeagueBattingReport(site.getLeagueBatting());</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>