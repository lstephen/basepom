<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SinglePlayer.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ootp-ai</a> &gt; <a href="index.source.html" class="el_package">com.github.lstephen.ootp.ai.ootp5.site</a> &gt; <span class="el_source">SinglePlayer.java</span></div><h1>SinglePlayer.java</h1><pre class="source lang-java linenums">package com.github.lstephen.ootp.ai.ootp5.site;

import com.google.common.base.CharMatcher;
import com.google.common.base.Optional;
import com.google.common.collect.ImmutableMap;
import com.google.common.collect.Ordering;
import com.github.lstephen.ootp.ai.player.BattingHand;
import com.github.lstephen.ootp.ai.player.Clutch;
import com.github.lstephen.ootp.ai.player.Consistency;
import com.github.lstephen.ootp.ai.player.Player;
import com.github.lstephen.ootp.ai.player.PlayerId;
import com.github.lstephen.ootp.ai.player.PlayerSource;
import com.github.lstephen.ootp.ai.player.ratings.DefensiveRatings;
import com.github.lstephen.ootp.ai.player.ratings.FieldingRatings;
import com.github.lstephen.ootp.ai.player.ratings.PitchingRatings;
import com.github.lstephen.ootp.ai.player.ratings.PlayerRatings;
import com.github.lstephen.ootp.ai.player.ratings.Position;
import com.github.lstephen.ootp.ai.player.ratings.StarRating;
import com.github.lstephen.ootp.ai.site.Site;
import com.github.lstephen.ootp.ai.site.Version;
import com.github.lstephen.ootp.ai.splits.Splits;
import com.github.lstephen.ootp.extract.html.rating.Rating;
import com.github.lstephen.ootp.extract.html.rating.Scale;
import java.util.logging.Level;
import java.util.logging.Logger;
import org.apache.commons.lang3.StringUtils;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.parser.Parser;
import org.jsoup.select.Elements;

/**
 *
 * @author lstephen
 */
<span class="fc" id="L36">public class SinglePlayer implements PlayerSource {</span>

<span class="fc" id="L38">  private static final Logger LOG = Logger.getLogger(SinglePlayer.class.getName());</span>

<span class="nc" id="L40">  private static enum BattingRatingsType { CONTACT, GAP, POWER, EYE }</span>

<span class="pc" id="L42">  private static enum PitchingRatingsType { HITS, GAP, TRIPLES, STUFF, CONTROL, MOVEMENT }</span>

  private static final ImmutableMap&lt;Position, Double&gt; AVERAGE_FPCT =
    ImmutableMap
<span class="fc" id="L46">      .&lt;Position, Double&gt;builder()</span>
<span class="fc" id="L47">      .put(Position.CATCHER, .952)</span>
<span class="fc" id="L48">      .put(Position.FIRST_BASE, .993)</span>
<span class="fc" id="L49">      .put(Position.SECOND_BASE, .981)</span>
<span class="fc" id="L50">      .put(Position.THIRD_BASE, .953)</span>
<span class="fc" id="L51">      .put(Position.SHORTSTOP, .967)</span>
<span class="fc" id="L52">      .put(Position.LEFT_FIELD, .977)</span>
<span class="fc" id="L53">      .put(Position.CENTER_FIELD, .984)</span>
<span class="fc" id="L54">      .put(Position.RIGHT_FIELD, .981)</span>
<span class="fc" id="L55">      .build();</span>

  private static final ImmutableMap&lt;PitchingRatingsType, Integer&gt; OOTP6_PITCHING =
<span class="fc" id="L58">    ImmutableMap.&lt;PitchingRatingsType, Integer&gt;builder()</span>
<span class="fc" id="L59">      .put(PitchingRatingsType.HITS, 1)</span>
<span class="fc" id="L60">      .put(PitchingRatingsType.GAP, 3)</span>
<span class="fc" id="L61">      .put(PitchingRatingsType.STUFF, 1)</span>
<span class="fc" id="L62">      .put(PitchingRatingsType.CONTROL, 2)</span>
<span class="fc" id="L63">      .put(PitchingRatingsType.MOVEMENT, 3)</span>
<span class="fc" id="L64">      .build();</span>

<span class="fc" id="L66">  private static final ImmutableMap&lt;PitchingRatingsType, Integer&gt; OOTP5_PITCHING =</span>
<span class="fc" id="L67">    ImmutableMap.&lt;PitchingRatingsType, Integer&gt;builder()</span>
<span class="fc" id="L68">      .put(PitchingRatingsType.HITS, 2)</span>
<span class="fc" id="L69">      .put(PitchingRatingsType.GAP, 3)</span>
<span class="fc" id="L70">      .put(PitchingRatingsType.STUFF, 6)</span>
<span class="fc" id="L71">      .put(PitchingRatingsType.CONTROL, 5)</span>
<span class="fc" id="L72">      .put(PitchingRatingsType.MOVEMENT, 4)</span>
<span class="fc" id="L73">      .build();</span>

  private Site site;

  private SalarySource salaries;

  public void setSite(Site site) {
<span class="fc" id="L80">    this.site = site;</span>
<span class="fc" id="L81">  }</span>

  public void setSalarySource(SalarySource salaries) {
<span class="fc" id="L84">    this.salaries = salaries;</span>
<span class="fc" id="L85">  }</span>

  private Document loadPage(PlayerId id) {
<span class="fc" id="L88">    return site.getPage(id.unwrap() + &quot;.html&quot;).load();</span>
  }

  @Override
  public Player get(PlayerId id) {
    try {
<span class="fc" id="L94">      return extract(id, loadPage(id));</span>
<span class="nc" id="L95">    } catch (Exception e) {</span>
<span class="nc" id="L96">      LOG.log(Level.WARNING, &quot;Player not found. ID: {0}&quot;, id);</span>
<span class="nc" id="L97">      return null;</span>
    }
  }

  private Player extract(PlayerId id, Document doc) {
<span class="fc" id="L102">    Elements title = doc.select(&quot;title&quot;);</span>

<span class="fc" id="L104">    String team = CharMatcher.WHITESPACE.trimAndCollapseFrom(</span>
<span class="fc" id="L105">        StringUtils.substringBefore(StringUtils.substringAfterLast(title.text(), &quot;,&quot;), &quot;-&quot;),</span>
        ' ');

<span class="fc" id="L108">    Elements info = doc.select(&quot;td.s4:has(b:contains(Name)) + td.s4&quot;);</span>

<span class="fc" id="L110">    String[] splitInfo =</span>
<span class="fc" id="L111">      StringUtils.splitByWholeSeparatorPreserveAllTokens(</span>
<span class="fc" id="L112">          info.html(), &quot;&lt;br /&gt;&quot;);</span>

<span class="pc bpc" id="L114" title="1 of 2 branches missed.">    if (splitInfo.length &lt; 9) {</span>
<span class="nc" id="L115">      LOG.log(Level.WARNING, &quot;Error extracting player. ID: {0}&quot;, id);</span>
<span class="nc" id="L116">      return null;</span>
    }

<span class="fc" id="L119">    String name = Parser.unescapeEntities(splitInfo[0], false);</span>
<span class="fc" id="L120">    Integer age = Integer.valueOf(splitInfo[3]);</span>


<span class="fc" id="L123">    String listedPosition = getListedPosition(splitInfo[8]);</span>

<span class="fc" id="L125">    PlayerPage page = PlayerPage.create(doc, site);</span>

<span class="fc" id="L127">    PlayerRatings ratings =</span>
<span class="fc" id="L128">      PlayerRatings.create(</span>
<span class="fc" id="L129">          page.extractBattingRatings(),</span>
<span class="fc" id="L130">          extractDefensiveRatings(doc),</span>
<span class="fc" id="L131">          extractPitchingRatings(doc),</span>
<span class="fc" id="L132">          site.getDefinition());</span>

<span class="fc" id="L134">    ratings.setBattingPotential(page.extractBattingPotential());</span>

<span class="pc bpc" id="L136" title="1 of 2 branches missed.">    if (ratings.hasPitching()) {</span>
<span class="nc" id="L137">      ratings.setPitchingPotential(extractPitchingPotential(doc));</span>
    }

<span class="fc" id="L140">    Player player = Player.create(id, name, ratings);</span>

<span class="fc" id="L142">    player.setAge(age);</span>
<span class="fc" id="L143">    player.setTeam(team);</span>
<span class="fc" id="L144">    player.setListedPosition(listedPosition);</span>
<span class="fc" id="L145">    player.setBattingHand(BattingHand.fromCode(splitInfo[9]));</span>

<span class="fc" id="L147">    player.setStars(StarRating.extractFrom(doc));</span>
<span class="fc" id="L148">    player.setClutch(Clutch.extractFrom(doc));</span>
<span class="fc" id="L149">    player.setConsistency(Consistency.extractFrom(doc));</span>

<span class="pc bpc" id="L151" title="1 of 2 branches missed.">    if (site.isInjured(player)) {</span>
<span class="nc" id="L152">      player.setInjured(Boolean.TRUE);</span>
    }

<span class="pc bpc" id="L155" title="1 of 2 branches missed.">    if (doc.html().contains(&quot;out for entire career&quot;)) {</span>
<span class="nc" id="L156">      player.setTeam(&quot;*CEI* &quot; + player.getTeam());</span>
    }

<span class="pc bpc" id="L159" title="1 of 2 branches missed.">    if (site.isFutureFreeAgent(player)) {</span>
<span class="nc" id="L160">      player.setUpcomingFreeAgent(Boolean.TRUE);</span>
    }

<span class="pc bpc" id="L163" title="1 of 2 branches missed.">    if (doc.html().contains(&quot;Rule 5 Draft Eligibility&quot;)) {</span>
<span class="nc" id="L164">      player.setRuleFiveEligible(isRuleFiveEligible(doc));</span>
    }

<span class="pc bpc" id="L167" title="1 of 2 branches missed.">    if (doc.html().contains(&quot;Rule 5 Draft Eligibility&quot;)) {</span>
<span class="nc" id="L168">      player.setOn40Man(doc.html().contains(&quot;on 40 Man Roster&quot;));</span>
    }

<span class="pc bpc" id="L171" title="1 of 2 branches missed.">    if (doc.html().contains(&quot;Minor League Option Years&quot;)) {</span>
<span class="nc bnc" id="L172" title="All 4 branches missed.">      if (!(site.getName().equals(&quot;BTH&quot;) || site.getName().contains(&quot;OLD_BTH&quot;))) {</span>
<span class="nc" id="L173">        player.setOutOfOptions(doc.html().contains(&quot;Out of Option Years&quot;));</span>
      }
    }

<span class="pc bpc" id="L177" title="1 of 2 branches missed.">    if (doc.html().contains(&quot;Minor League Option Years&quot;)) {</span>
<span class="nc bnc" id="L178" title="All 4 branches missed.">      if (!(site.getName().equals(&quot;BTH&quot;) || site.getName().contains(&quot;OLD_BTH&quot;))) {</span>
<span class="nc" id="L179">        player.setClearedWaivers(doc.html().contains(&quot;Waivers cleared&quot;));</span>
      }
    }

<span class="pc bpc" id="L183" title="1 of 2 branches missed.">    if (doc.html().contains(&quot;Years of Pro Service&quot;)) {</span>
<span class="nc" id="L184">      player.setYearsOfProService(getYearsOfProService(doc));</span>
    }

<span class="fc" id="L187">    Optional&lt;Integer&gt; teamTopProspectPosition =</span>
<span class="fc" id="L188">      site.getTeamTopProspectPosition(id);</span>

<span class="pc bpc" id="L190" title="1 of 2 branches missed.">    if (teamTopProspectPosition.isPresent()) {</span>
<span class="nc" id="L191">      player.setTeamTopProspectPosition(teamTopProspectPosition.get());</span>
    }


<span class="fc" id="L195">    player.setSalary(salaries.getSalary(player));</span>

<span class="fc" id="L197">    return player;</span>
  }

  private String getListedPosition(String src) {
<span class="fc" id="L201">    String p = CharMatcher.WHITESPACE.trimFrom(src);</span>

    ImmutableMap&lt;String, String&gt; ps = ImmutableMap
<span class="fc" id="L204">      .&lt;String, String&gt;builder()</span>
<span class="fc" id="L205">      .put(&quot;Starting Pitcher&quot;, &quot;SP&quot;)</span>
<span class="fc" id="L206">      .put(&quot;Pitcher&quot;, &quot;P&quot;)</span>
<span class="fc" id="L207">      .put(&quot;Reliever&quot;, &quot;MR&quot;)</span>
<span class="fc" id="L208">      .put(&quot;Closer&quot;, &quot;CL&quot;)</span>
<span class="fc" id="L209">      .put(&quot;Catcher&quot;, &quot;C&quot;)</span>
<span class="fc" id="L210">      .put(&quot;First Base&quot;, &quot;1B&quot;)</span>
<span class="fc" id="L211">      .put(&quot;Second Base&quot;, &quot;2B&quot;)</span>
<span class="fc" id="L212">      .put(&quot;Third Base&quot;, &quot;3B&quot;)</span>
<span class="fc" id="L213">      .put(&quot;Shortstop&quot;, &quot;SS&quot;)</span>
<span class="fc" id="L214">      .put(&quot;Leftfield&quot;, &quot;LF&quot;)</span>
<span class="fc" id="L215">      .put(&quot;Centerfield&quot;, &quot;CF&quot;)</span>
<span class="fc" id="L216">      .put(&quot;Rightfield&quot;, &quot;RF&quot;)</span>
<span class="fc" id="L217">      .put(&quot;Designated Hitter&quot;, &quot;DH&quot;)</span>
<span class="fc" id="L218">      .build();</span>

<span class="pc bpc" id="L220" title="1 of 2 branches missed.">    if (!ps.containsKey(p)) {</span>
<span class="nc" id="L221">      throw new IllegalStateException(&quot;Unknown Position:&quot; + p);</span>
    }

<span class="fc" id="L224">    return ps.get(p);</span>
  }

  private Boolean isRuleFiveEligible(Document doc) {
<span class="nc" id="L228">    return extractContractText(doc, &quot;Rule 5 Draft Eligibility :&quot;).contains(&quot;Eligible&quot;);</span>
  }

  private Integer getYearsOfProService(Document doc) {
<span class="nc" id="L232">    String raw = extractContractText(doc, &quot;Years of Pro Service :&quot;);</span>

<span class="nc" id="L234">    return Integer.parseInt(StringUtils.substringBefore(raw, &quot; &quot;));</span>
  }

  private String extractContractText(Document doc, String title) {
<span class="nc" id="L238">    String titles = doc.select(&quot;td.s4:contains(Contract)&quot;).html();</span>

<span class="nc" id="L240">    String[] splitTitles = StringUtils.splitByWholeSeparatorPreserveAllTokens(titles, &quot;&lt;br /&gt;&quot;);</span>

<span class="nc" id="L242">    int idx = -1;</span>

<span class="nc bnc" id="L244" title="All 2 branches missed.">    for (int i = 0; i &lt; splitTitles.length; i++) {</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">      if (splitTitles[i].equals(title)) {</span>
<span class="nc" id="L246">        idx = i;</span>
<span class="nc" id="L247">        break;</span>
      }
    }

<span class="nc bnc" id="L251" title="All 2 branches missed.">    if (idx &lt; 0) {</span>
<span class="nc" id="L252">      return null;</span>
    }

<span class="nc" id="L255">    String raw = doc.select(&quot;td.s4:contains(Contract) + td.s4&quot;).html();</span>

<span class="nc" id="L257">    String[] split = StringUtils.splitByWholeSeparatorPreserveAllTokens(raw, &quot;&lt;br /&gt;&quot;);</span>

<span class="nc" id="L259">    return split[idx];</span>
  }

  private DefensiveRatings extractDefensiveRatings(Document doc) {
<span class="fc" id="L263">    DefensiveRatings ratings = new DefensiveRatings();</span>

<span class="fc" id="L265">    String raw = doc.select(&quot;td.s4:contains(Fielding Ratings)&quot;).text();</span>

<span class="fc bfc" id="L267" title="All 2 branches covered.">    for (Position p : Position.values()) {</span>
<span class="fc bfc" id="L268" title="All 2 branches covered.">      if (raw.contains(p.getAbbreviation() + &quot; :&quot;)) {</span>
<span class="fc" id="L269">        Integer rating = extractPositionRating(raw, p.getAbbreviation());</span>

<span class="pc bpc" id="L271" title="3 of 4 branches missed.">        if (p == Position.CATCHER &amp;&amp; rating == 0) {</span>
<span class="nc" id="L272">          rating = 0;</span>
        }
<span class="fc" id="L274">        ratings.setPositionRating(p, (double) rating);</span>
      }
    }

<span class="fc" id="L278">    ratings.setCatcher(extractCatcherRating(raw));</span>
<span class="fc" id="L279">    ratings.setInfield(extractInfieldRating(raw));</span>
<span class="fc" id="L280">    ratings.setOutfield(extractOutfieldRating(raw));</span>

<span class="fc" id="L282">    return ratings;</span>
  }

  private Splits&lt;PitchingRatings&lt;?&gt;&gt; extractPitchingRatings(Document doc) {
<span class="fc" id="L286">    Elements vsLhb = doc.select(&quot;tr.g:has(td:contains(Versus LHB))&quot;);</span>
<span class="fc" id="L287">    Elements vsRhb = doc.select(&quot;tr.g2:has(td:contains(Versus RHB))&quot;);</span>

<span class="pc bpc" id="L289" title="2 of 4 branches missed.">    if (site.getType() == Version.OOTP5 &amp;&amp; doc.html().contains(&quot;Pitching Ratings&quot;)) {</span>
<span class="nc" id="L290">      vsLhb = doc.select(&quot;tr.g:has(td:contains(vs. LHP)&quot;);</span>
<span class="nc" id="L291">      vsRhb = doc.select(&quot;tr.g2:has(td:contains(vs. RHP)&quot;);</span>
    }

<span class="pc bpc" id="L294" title="3 of 4 branches missed.">    if (vsLhb.isEmpty() || vsRhb.isEmpty()) {</span>
<span class="fc" id="L295">      return null;</span>
    }

<span class="nc" id="L298">    String raw = doc.select(&quot;td.s1:contains(Pitching Ratings) + td&quot;).html();</span>

    int endurance;
<span class="pc bnc" id="L301" title="All 3 branches missed.">    switch (site.getType()) {</span>
      case OOTP6:
<span class="nc" id="L303">        endurance = Integer.parseInt(StringUtils.substringBetween(raw, &quot;&lt;br /&gt;&quot;, &quot;&lt;br /&gt;&quot;).trim());</span>
<span class="nc" id="L304">        break;</span>
      case OOTP5:
<span class="nc" id="L306">        String starter = StringUtils.substringBetween(raw, &quot;&lt;br /&gt;&quot;, &quot;&lt;br /&gt;&quot;).trim();</span>

<span class="nc bnc" id="L308" title="All 2 branches missed.">        if (!starter.equals(&quot;-&quot;)) {</span>
<span class="nc" id="L309">          endurance = 10 - (starter.charAt(0) - 'A');</span>
<span class="nc" id="L310">          break;</span>
        }

<span class="nc" id="L313">        String reliever = StringUtils.substringBetween(raw, &quot;-&lt;br /&gt;&quot;, &quot;&lt;br /&gt;&quot;).trim();</span>

<span class="nc bnc" id="L315" title="All 2 branches missed.">        if (!reliever.equals(&quot;-&quot;)) {</span>
<span class="nc" id="L316">          endurance = 5 - (reliever.charAt(0) - 'A');</span>
<span class="nc" id="L317">          break;</span>
        }

<span class="nc" id="L320">        endurance = 1;</span>
<span class="nc" id="L321">        break;</span>
      default:
<span class="nc" id="L323">        throw new IllegalStateException();</span>
    }

<span class="nc" id="L326">    PitchingRatings&lt;?&gt; l = extractPitchingRatings(vsLhb.get(0), site.getAbilityRatingScale(), endurance);</span>
<span class="nc" id="L327">    PitchingRatings&lt;?&gt; r = extractPitchingRatings(vsRhb.get(0), site.getAbilityRatingScale(), endurance);</span>

<span class="nc" id="L329">    return Splits.create(l, r);</span>
  }

  private PitchingRatings&lt;?&gt; extractPitchingPotential(Document doc) {
<span class="nc" id="L333">    Elements talent = doc.select(&quot;tr.g:has(td:contains(Talent))&quot;);</span>

<span class="nc" id="L335">    return extractPitchingRatings(</span>
<span class="nc" id="L336">        talent.get(0),</span>
<span class="nc" id="L337">        site.getPotentialRatingScale(),</span>
<span class="nc" id="L338">        extractPitchingRatings(doc).getVsLeft().getEndurance());</span>
  }

  private Integer extractRange(String raw, String position) {
<span class="fc bfc" id="L342" title="All 2 branches covered.">    if (!raw.contains(position + &quot; :&quot;)) {</span>
<span class="fc" id="L343">      return 0;</span>
    }
<span class="fc" id="L345">    return ratingFromString(StringUtils.substringBetween(raw, position + &quot; :&quot;, &quot;(Range)&quot;).trim());</span>
  }

  private Double extractFieldingPct(String raw, String position) {
<span class="fc bfc" id="L349" title="All 2 branches covered.">    if (!raw.contains(position + &quot; :&quot;)) {</span>
<span class="fc" id="L350">      return 0.0;</span>
    }

<span class="fc" id="L353">    String rawPosStr = StringUtils.substringBetween(raw, position + &quot; :&quot;, &quot;(Fielding Pct.)&quot;);</span>

<span class="fc" id="L355">    return Double.valueOf(StringUtils.substringAfter(rawPosStr, &quot;(Range),&quot;).trim());</span>
  }

  private Integer extractPositionRating(String raw, String position) {
    /*String rawPosStr = StringUtils.substringBetween(raw, position + &quot; :&quot;, &quot;(Fielding Pct.)&quot;);

      Double fpct = Double.valueOf(StringUtils.substringAfter(rawPosStr, &quot;(Range),&quot;).trim());

      return extractRange(raw, position).doubleValue() + (fpct / 1000.0);*/
<span class="fc" id="L364">    return extractRange(raw, position);</span>
  }

  private FieldingRatings extractCatcherRating(String raw) {
    return FieldingRatings
<span class="fc" id="L369">      .builder()</span>
<span class="fc" id="L370">      .ability(extractRange(raw, &quot;C&quot;) * 10)</span>
<span class="pc bpc" id="L371" title="1 of 2 branches missed.">      .arm(ratingFromString(StringUtils.substringBetween(raw, &quot;Catcher Arm :&quot;, raw.contains(&quot;Infield&quot;) ? &quot;Infield&quot; : &quot;Outfield&quot;)) * 10)</span>
<span class="fc" id="L372">      .build();</span>
  }

  private FieldingRatings extractInfieldRating(String raw) {
<span class="fc" id="L376">    Integer first = 2 * extractRange(raw, &quot;1B&quot;);</span>
<span class="fc" id="L377">    Integer second = 8 * extractRange(raw, &quot;2B&quot;);</span>
<span class="fc" id="L378">    Integer third = 8 * extractRange(raw, &quot;3B&quot;);</span>
<span class="fc" id="L379">    Integer shortstop = 10 * extractRange(raw, &quot;SS&quot;);</span>

<span class="fc" id="L381">    Integer range = Ordering.natural().max(first, second, third, shortstop);</span>
<span class="pc bpc" id="L382" title="1 of 2 branches missed.">    Integer arm = site.getType() == Version.OOTP5</span>
      ? 50
<span class="nc" id="L384">      : ratingFromString(StringUtils.substringBetween(raw, &quot;Infield Arm :&quot;, &quot;Outfield&quot;)) * 10;</span>


<span class="fc" id="L387">    Integer firstErrors = extractAndAdapt(raw, Position.FIRST_BASE);</span>
<span class="fc" id="L388">    Integer secondErrors = extractAndAdapt(raw, Position.SECOND_BASE);</span>
<span class="fc" id="L389">    Integer thirdErrors = extractAndAdapt(raw, Position.THIRD_BASE);</span>
<span class="fc" id="L390">    Integer shortstopErrors = extractAndAdapt(raw, Position.SHORTSTOP);</span>

<span class="fc" id="L392">    Integer n = 2*firstErrors + 8*secondErrors + 8*thirdErrors + 10*shortstopErrors;</span>

<span class="pc bpc" id="L394" title="1 of 2 branches missed.">    Integer d = (first == 0 ? 0 : 2)</span>
<span class="pc bpc" id="L395" title="1 of 2 branches missed.">      + (second == 0 ? 0 : 8)</span>
<span class="pc bpc" id="L396" title="1 of 2 branches missed.">      + (third == 0 ? 0 : 8)</span>
<span class="pc bpc" id="L397" title="1 of 2 branches missed.">      + (shortstop == 0 ? 0 : 10);</span>

<span class="pc bpc" id="L399" title="1 of 2 branches missed.">    Integer errors = d == 0 ? 0 : (int) Math.round((double) n / d);</span>

    return FieldingRatings
<span class="fc" id="L402">      .builder()</span>
<span class="fc" id="L403">      .range(range)</span>
<span class="fc" id="L404">      .arm(arm)</span>
<span class="fc" id="L405">      .errors(errors)</span>
<span class="fc" id="L406">      .dp(arm)</span>
<span class="fc" id="L407">      .build();</span>
  }

  private FieldingRatings extractOutfieldRating(String raw) {
<span class="fc" id="L411">    Integer first = 3 * extractRange(raw, &quot;1B&quot;);</span>
<span class="fc" id="L412">    Integer lf = 7 * extractRange(raw, &quot;LF&quot;);</span>
<span class="fc" id="L413">    Integer cf = 10 * extractRange(raw, &quot;CF&quot;);</span>
<span class="fc" id="L414">    Integer rf = 7 * extractRange(raw, &quot;RF&quot;);</span>

<span class="fc" id="L416">    Integer range = Ordering.natural().max(first, lf, cf, rf);</span>
<span class="fc" id="L417">    Integer arm = ratingFromString(StringUtils.substringAfter(raw, &quot;Outfield Arm :&quot;)) * 10;</span>

<span class="fc" id="L419">    Integer firstErrors = extractAndAdapt(raw, Position.FIRST_BASE);</span>
<span class="fc" id="L420">    Integer lfErrors = extractAndAdapt(raw, Position.LEFT_FIELD);</span>
<span class="fc" id="L421">    Integer cfErrors = extractAndAdapt(raw, Position.CENTER_FIELD);</span>
<span class="fc" id="L422">    Integer rfErrors = extractAndAdapt(raw, Position.RIGHT_FIELD);</span>

<span class="fc" id="L424">    Integer n = 3*firstErrors + 7*lfErrors + 10*cfErrors + 7*rfErrors;</span>
<span class="pc bpc" id="L425" title="1 of 2 branches missed.">    Integer d = (first == 0 ? 0 : 3)</span>
<span class="pc bpc" id="L426" title="1 of 2 branches missed.">      + (lf == 0 ? 0 : 7)</span>
<span class="pc bpc" id="L427" title="1 of 2 branches missed.">      + (cf == 0 ? 0 : 10)</span>
<span class="pc bpc" id="L428" title="1 of 2 branches missed.">      + (rf == 0 ? 0 : 7);</span>

<span class="pc bpc" id="L430" title="1 of 2 branches missed.">    Integer errors = d == 0 ? 0 : (int) Math.round((double) n / d);</span>

    return FieldingRatings
<span class="fc" id="L433">      .builder()</span>
<span class="fc" id="L434">      .range(range)</span>
<span class="fc" id="L435">      .arm(arm)</span>
<span class="fc" id="L436">      .errors(errors)</span>
<span class="fc" id="L437">      .build();</span>
  }

  private Integer extractAndAdapt(String raw, Position p) {
<span class="fc" id="L441">    return adaptFpct(p, extractFieldingPct(raw, p.getAbbreviation()));</span>
  }

  private Integer adaptFpct(Position p, Double fpct) {
<span class="fc" id="L445">    Double avg = AVERAGE_FPCT.get(p);</span>

<span class="fc" id="L447">    Double ptsPerPct = 50.0 / (1.0 - avg);</span>

<span class="fc" id="L449">    Double result = 50.0 + (fpct - avg) * ptsPerPct;</span>

<span class="fc" id="L451">    return (int) Math.max(0, Math.round(result));</span>
  }

  private Integer ratingFromString(String s) {
<span class="pc bpc" id="L455" title="1 of 2 branches missed.">    if (s == null) { return 0; }</span>

<span class="pc bpc" id="L457" title="2 of 3 branches missed.">    switch (site.getType()) {</span>
      case OOTP6:
<span class="nc bnc" id="L459" title="All 2 branches missed.">        if (s.trim().equals(&quot;-&quot;)) {</span>
<span class="nc" id="L460">          return 0;</span>
        }
<span class="nc" id="L462">        return Integer.parseInt(s.trim());</span>
      case OOTP5:
<span class="pc bpc" id="L464" title="17 of 26 branches missed.">        switch (s.trim()) {</span>
<span class="fc" id="L465">          case &quot;A&quot;: return 9;</span>
<span class="nc" id="L466">          case &quot;B&quot;: return 7;</span>
<span class="nc" id="L467">          case &quot;C&quot;: return 5;</span>
<span class="fc" id="L468">          case &quot;D&quot;: return 3;</span>
<span class="nc" id="L469">          case &quot;E&quot;: return 1;</span>
<span class="fc" id="L470">          case &quot;-&quot;: return 0;</span>
<span class="nc" id="L471">          default: throw new IllegalStateException();</span>
        }
      default:
<span class="nc" id="L474">        throw new IllegalStateException();</span>
    }
  }

  private &lt;T&gt; PitchingRatings&lt;T&gt; extractPitchingRatings(Element el, Scale&lt;T&gt; scale, int endurance) {
<span class="nc" id="L479">    Elements line = el.children();</span>

    ImmutableMap&lt;PitchingRatingsType, Integer&gt; idx;
<span class="nc bnc" id="L482" title="All 3 branches missed.">    switch (site.getType()) {</span>
      case OOTP5:
<span class="nc" id="L484">        idx = OOTP5_PITCHING;</span>
<span class="nc" id="L485">        break;</span>
      case OOTP6:
<span class="nc" id="L487">        idx = OOTP6_PITCHING;</span>
<span class="nc" id="L488">        break;</span>
      default:
<span class="nc" id="L490">        throw new IllegalStateException();</span>
    }

<span class="nc" id="L493">    PitchingRatings&lt;T&gt; ratings = PitchingRatings</span>
<span class="nc" id="L494">      .builder(scale)</span>
<span class="nc" id="L495">      .hits(line.get(idx.get(PitchingRatingsType.HITS)).text())</span>
<span class="nc" id="L496">      .gap(line.get(idx.get(PitchingRatingsType.GAP)).text())</span>
<span class="nc" id="L497">      .stuff(line.get(idx.get(PitchingRatingsType.STUFF)).text())</span>
<span class="nc" id="L498">      .control(line.get(idx.get(PitchingRatingsType.CONTROL)).text())</span>
<span class="nc" id="L499">      .movement(line.get(idx.get(PitchingRatingsType.MOVEMENT)).text())</span>
<span class="nc" id="L500">      .endurance(endurance)</span>
<span class="nc" id="L501">      .build();</span>

<span class="nc" id="L503">    return ratings;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>