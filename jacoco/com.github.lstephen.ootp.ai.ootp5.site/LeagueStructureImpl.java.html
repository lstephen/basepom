<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>LeagueStructureImpl.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ootp-ai</a> &gt; <a href="index.source.html" class="el_package">com.github.lstephen.ootp.ai.ootp5.site</a> &gt; <span class="el_source">LeagueStructureImpl.java</span></div><h1>LeagueStructureImpl.java</h1><pre class="source lang-java linenums">package com.github.lstephen.ootp.ai.ootp5.site;

import com.github.lstephen.ootp.ai.data.Id;
import com.github.lstephen.ootp.ai.roster.Team;
import com.github.lstephen.ootp.ai.site.LeagueStructure;
import com.github.lstephen.ootp.ai.site.Site;

import java.util.List;

import com.google.common.base.CharMatcher;
import com.google.common.base.Strings;
import com.google.common.collect.Lists;
import org.apache.commons.lang3.StringUtils;

import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

/**
 *
 * @author lstephen
 */
public class LeagueStructureImpl implements LeagueStructure {

    private final Site site;

<span class="nc" id="L27">    private LeagueStructureImpl(Site site) {</span>
<span class="nc" id="L28">        this.site = site;</span>
<span class="nc" id="L29">    }</span>

    private Document standings() {
<span class="nc" id="L32">        return Pages.standings(site).load();</span>
    }

    public Iterable&lt;League&gt; getLeagues() {
<span class="nc" id="L36">        Document doc = standings();</span>

<span class="nc" id="L38">        Elements els = doc.select(&quot;td.s5:containsOwn(Standings)&quot;);</span>

<span class="nc" id="L40">        List&lt;League&gt; leagues = Lists.newArrayList();</span>

<span class="nc bnc" id="L42" title="All 2 branches missed.">        for (Element e : els) {</span>
<span class="nc bnc" id="L43" title="All 2 branches missed.">            if (e.text().contains(&quot;,&quot;)) {</span>
<span class="nc" id="L44">                continue;</span>
            }
<span class="nc" id="L46">            final String name = CharMatcher.WHITESPACE.trimFrom(StringUtils.substringBeforeLast(e.text(), &quot;Standings&quot;));</span>
<span class="nc" id="L47">            leagues.add(new League() {</span>
                public String getName() {
<span class="nc" id="L49">                    return name;</span>
                }

                public Iterable&lt;Division&gt; getDivisions() {
<span class="nc" id="L53">                    return LeagueStructureImpl.this.getDivisions(name);</span>
                }
            });
<span class="nc" id="L56">        }</span>

<span class="nc" id="L58">        return leagues;</span>
    }

    private Iterable&lt;Division&gt; getDivisions(final String league) {
<span class="nc" id="L62">        Document doc = standings();</span>

<span class="nc" id="L64">        Element leagueEl = doc.select(&quot;tr:has(td.s5:containsOwn(&quot; + league + &quot; Standings))&quot;).first();</span>

<span class="nc" id="L66">        List&lt;Division&gt; divisions = Lists.newArrayList();</span>

<span class="nc" id="L68">        Element divEl = leagueEl.nextElementSibling();</span>

<span class="nc bnc" id="L70" title="All 2 branches missed.">        while (divEl.select(&quot;td.s5:containsOwn(Standings)&quot;).isEmpty()) {</span>
<span class="nc" id="L71">            final String name = CharMatcher.WHITESPACE.trimFrom(divEl.select(&quot;td.s5&quot;).text());</span>

<span class="nc bnc" id="L73" title="All 2 branches missed.">            if (Strings.isNullOrEmpty(name)) {</span>
<span class="nc" id="L74">                break;</span>
            }

<span class="nc" id="L77">            divisions.add(new Division() {</span>

                @Override
                public String getName() {
<span class="nc" id="L81">                    return name;</span>
                }

                @Override
                public Iterable&lt;Id&lt;Team&gt;&gt; getTeams() {
<span class="nc" id="L86">                    return LeagueStructureImpl.this.getTeams(league, name);</span>
                }
            });

<span class="nc" id="L90">            divEl = divEl.nextElementSibling().nextElementSibling();</span>
<span class="nc" id="L91">        }</span>

<span class="nc" id="L93">        return divisions;</span>
    }


    private Iterable&lt;Id&lt;Team&gt;&gt; getTeams(String league, String division) {
<span class="nc" id="L98">        Document doc = standings();</span>

<span class="nc" id="L100">        Elements els = doc</span>
<span class="nc" id="L101">            .select(&quot;tr:has(td.s5:containsOwn(&quot; + league + &quot;)) ~ tr:has(td.s5:containsOwn(&quot; + division + &quot;)) + tr&quot;)</span>
<span class="nc" id="L102">            .first()</span>
<span class="nc" id="L103">            .select(&quot;a&quot;);</span>


<span class="nc" id="L106">        List&lt;Id&lt;Team&gt;&gt; teams = Lists.newArrayList();</span>

<span class="nc bnc" id="L108" title="All 2 branches missed.">        for (Element el : els) {</span>
<span class="nc" id="L109">            teams.add(Id.&lt;Team&gt;valueOf(StringUtils.substringBetween(el.attr(&quot;href&quot;), &quot;team&quot;, &quot;.html&quot;)));</span>
<span class="nc" id="L110">        }</span>

<span class="nc" id="L112">        return teams;</span>
    }

    public static LeagueStructureImpl create(Site site) {
<span class="nc" id="L116">        return new LeagueStructureImpl(site);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>